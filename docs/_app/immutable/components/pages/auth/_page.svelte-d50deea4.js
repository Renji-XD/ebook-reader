import{S as g,i as w,n as _,j as $,w as y,k as S,l as x,x as P,f,m as E,a as A,y as C,B as U,d as v,t as R,z as k}from"../../../chunks/index-876111f7.js";import{F as q,f as H}from"../../../chunks/fa-26600f17.js";import{s as I}from"../../../chunks/error-handler-df8dffd6.js";function b(s){let n,e,t;return e=new q({props:{icon:H,spin:!0}}),{c(){n=$("div"),y(e.$$.fragment),this.h()},l(r){n=S(r,"DIV",{class:!0});var o=x(n);P(e.$$.fragment,o),o.forEach(f),this.h()},h(){E(n,"class","fixed inset-0 flex h-full w-full items-center justify-center text-7xl")},m(r,o){A(r,n,o),C(e,n,null),t=!0},p:U,i(r){t||(v(e.$$.fragment,r),t=!0)},o(r){R(e.$$.fragment,r),t=!1},d(r){r&&f(n),k(e)}}}function d(s,n,e){!window.opener||window.opener.postMessage({type:"failure",payload:{message:n,detail:`${n}
${e}`}},s)}function m(s,n,e,t,r=!1,o){if(!!window.opener){if(!n||!e||!t||r&&!o){d(s,"A required authentication property was not found",`Had Token: ${!!n}
Had Expiration: ${!!e}
Had Scope"${!!t}${r?`
Had Refresh Token"${!!o}`:""}`);return}window.opener.postMessage({type:"auth",payload:{accessToken:n,scope:t,expiration:Date.now()+(Number.parseInt(e,10)-600)*1e3,refreshToken:o}},s)}}function u(s,n){return new Promise((e,t)=>{if(!window.opener)return;const r=new MessageChannel;r.port1.onmessage=({data:o})=>{r.port1.close(),o.error?t(new Error(o.error)):e(o.result)},window.opener.postMessage(n,s,[r.port2])})}function z(s){async function n(){const e=new URL(window.location.href),t=new URLSearchParams(e.hash.substring(1)),r=t.has("error_description")||t.has("error"),o=`${e.origin}${e.pathname}`;if(r)d(e.origin,"Authorization failed",t.get("error_description")||t.get("error")||"Unknown error");else if(e.searchParams.has("code")){const a=new URLSearchParams,{clientId:c,clientSecret:l,sendSecret:p,tokenEndpoint:h}=await u(e.origin,{type:"getAuthVariables"});a.append("grant_type","authorization_code"),a.append("redirect_uri",o),a.append("client_id",c),p&&l&&a.append("client_secret",l),a.append("code",e.searchParams.get("code")||""),a.append("code_verifier",await u(e.origin,{type:"getCodeVerifier"})),fetch(h,{method:"POST",body:a.toString(),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(async i=>{if(!i.ok)throw new Error(await I(i));return i.json()}).then(i=>{m(e.origin,i.access_token,i.expires_in,i.scope,!0,i.refresh_token)}).catch(i=>{d(e.origin,"Code authorization request failed",i.message)})}else if(t.has("access_token"))m(e.origin,t.get("access_token"),t.get("expires_in"),t.get("scope"),!1);else if(e.searchParams.has("ttu-init-auth")){const a=new URLSearchParams,{clientId:c,clientSecret:l,authEndpoint:p,tokenEndpoint:h,scope:i}=await u(e.origin,{type:"getAuthVariables"});if(!c||!i||!p)return d(e.origin,"A required authentication input was not found",`ClientId: ${!!c}
Scope: ${!!i}
AuthEndpoint: ${!!p}`);a.append("client_id",c),a.append("redirect_uri",o),a.append("scope",i),l&&h?(a.append("response_type","code"),a.append("access_type","offline"),a.append("code_challenge_method","S256"),a.append("code_challenge",await u(e.origin,{type:"getCodeChallenge"})),a.append("prompt","consent")):a.append("response_type","token"),window.location.assign(`${p}?${a.toString()}`)}else e.searchParams.has("ttu-init-wait")||d(e.origin,"Unexpected authentication context",`Url: ${e.href}
Hash: ${e.hash||"-"}`)}return n(),[]}class j extends g{constructor(n){super(),w(this,n,z,b,_,{})}}export{j as default};
